<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤ë§ˆíŠ¸ ë‹¨ì²™ CP (ì˜¤íƒ€ ê°ì§€ & ì‹¤ì‹œê°„ ê²€ì¦)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f4f6f8; margin: 0; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        .excel-table { width: 100%; border-collapse: collapse; text-align: center; font-size: 13px; background: white; border: 2px solid #000; margin-bottom: 30px; }
        .excel-table th, .excel-table td { border: 1px solid #000; padding: 4px; vertical-align: middle; }
        .excel-table th { background-color: #ffe699; font-weight: bold; border-bottom: 2px solid #000; }
        
        /* ì…ë ¥ ì…€ ìŠ¤íƒ€ì¼ */
        .input-cell { width: 100%; height: 100%; min-height: 24px; border: none; background: transparent; text-align: center; outline: none; font-size: 13px; cursor: text; }
        .input-cell:focus { background-color: #e0f2fe; box-shadow: inset 0 0 0 2px #3b82f6; z-index: 10; position: relative; }
        
        /* 2000 ë¯¸ë§Œ ê²½ê³  ìŠ¤íƒ€ì¼ */
        .warn-low-length { color: #dc2626; font-weight: 800; }
        
        .spec-title { font-size: 1.25rem; font-weight: bold; color: #1e3a8a; margin-bottom: 8px; border-left: 4px solid #1e3a8a; padding-left: 10px; }
        
        .drag-handle { cursor: grab; color: #adb5bd; touch-action: none; }
        .drag-handle:active { cursor: grabbing; color: #495057; }
        
        .excel-input-cell { width:100%; height:100%; border:none; text-align:center; outline:none; background:transparent; font-size:12px; }
        .excel-input-cell:focus { background-color: #e3f2fd; font-weight:bold; }

        /* ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .checkbox-wrapper { display: flex; align-items: center; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 4px; cursor: pointer; transition: all 0.2s; }
        .checkbox-wrapper:hover { background-color: #f8fafc; }
        .checkbox-wrapper.selected { background-color: #eff6ff; border-color: #3b82f6; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // ì•„ì´ì½˜ ì»´í¬ë„ŒíŠ¸ë“¤
        const Plus = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M5 12h14"/><path d="M12 5v14"/></svg>;
        const Trash2 = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>;
        const Download = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>;
        const DragIcon = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>;
        const Refresh = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>;
        const Check = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20 6 9 17 4 12"></polyline></svg>;
        const ArrowRight = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>;
        const AlertCircle = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>;

        const getEmptyCuts = () => Array(8).fill().map(() => ({l: '', count: '', marking: ''}));
        const getEmptyRow = (t='2.10', w='100', h='100') => ({ id: Date.now() + Math.random(), t, w, h, qty: 1, cuts: getEmptyCuts() });

        function App() {
            const [viewMode, setViewMode] = useState('input');
            const [projectInfo, setProjectInfo] = useState({ company: '', siteName: '', memo: '', isNoDong: false, isBanding: true, isUnder1Ton: false });
            
            const [dongs, setDongs] = useState(['1ë™']);
            const [currentDong, setCurrentDong] = useState('1ë™');

            const defaultDongData = { 
                inputMode: 'sales', gridData: [], colMapping: { 1: 'width', 2: 'height', 3: 'thickness', 4: 'length', 8: 'qty', 13: 'marking' }, 
                parsedItems: [], availableSpecs: [], selectedSpecs: [], manualRows: {}, currentManualSpec: '', cpResult: null 
            };
            const [dongDataStore, setDongDataStore] = useState({ '1ë™': JSON.parse(JSON.stringify(defaultDongData)) });
            const currentData = dongDataStore[currentDong] || defaultDongData;
            
            const updateCurrentData = (updates) => {
                setDongDataStore(prev => ({ ...prev, [currentDong]: { ...prev[currentDong], ...updates } }));
            };

            const addDong = () => {
                const name = prompt("ìƒˆ ë™ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 2ë™):");
                if (name && !dongs.includes(name)) {
                    setDongs([...dongs, name]);
                    setDongDataStore(prev => ({ ...prev, [name]: JSON.parse(JSON.stringify(defaultDongData)) }));
                    setCurrentDong(name);
                }
            };
            const deleteDong = (name) => {
                if(dongs.length <= 1) return alert("ìµœì†Œ 1ê°œì˜ ë™ì€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.");
                if(confirm(`'${name}'ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    setDongs(dongs.filter(d => d !== name));
                    if(currentDong === name) setCurrentDong(dongs[0]);
                    setDongDataStore(prev => { const n = {...prev}; delete n[name]; return n; });
                }
            };

            const handlePaste = (e) => {
                e.preventDefault();
                const text = e.clipboardData.getData('text');
                const rows = text.trim().split('\n').map(row => row.split('\t'));
                updateCurrentData({ gridData: rows });
            };

            // ê°œë³„ ë™ ì¶”ì¶œ ë¡œì§
            const extractDataForDong = (data) => {
                let items = [];
                let specSet = new Set();
                const { gridData, colMapping } = data;
                
                const getIdx = (key) => Object.keys(colMapping).find(k => colMapping[k] === key);
                const tIdx = getIdx('thickness'); const wIdx = getIdx('width'); const hIdx = getIdx('height');
                const lenIdx = getIdx('length'); const qtyIdx = getIdx('qty'); const markIdx = getIdx('marking');

                if (!lenIdx || !qtyIdx) return { items: [], specs: [] };

                gridData.forEach(row => {
                    let rawLen = parseFloat(String(row[lenIdx]||'').replace(/,/g, '').trim());
                    let qty = parseInt(String(row[qtyIdx]||'').replace(/,/g, '').replace(/[^0-9]/g, '').trim());
                    let lengthInMm = (rawLen > 0 && rawLen < 20) ? Math.round(rawLen * 1000) : Math.round(rawLen);

                    if (lengthInMm > 0 && lengthInMm < 2000 && qty > 0) {
                        let thick = parseFloat(String(row[tIdx]||'2.1').replace(/[^0-9.]/g, ''));
                        let formattedThick = Number.isInteger(thick) ? thick.toFixed(1) : thick.toString();
                        if (formattedThick === '2.10') formattedThick = '2.1';
                        
                        let width = parseInt(String(row[wIdx]||'100').replace(/[^0-9]/g, ''));
                        let height = parseInt(String(row[hIdx]||'100').replace(/[^0-9]/g, ''));
                        let marking = String(row[markIdx]||'').trim();
                        let specKey = `${width}*${height} ${formattedThick}T`;

                        specSet.add(specKey);
                        let existing = items.find(i => i.specKey === specKey && i.length === lengthInMm && i.marking === marking);
                        if (existing) existing.qty += qty;
                        else items.push({ specKey, thick, width, height, length: lengthInMm, qty, marking });
                    }
                });
                
                return { items, specs: Array.from(specSet).sort() };
            };

            const extractData = () => {
                const { items, specs } = extractDataForDong(currentData);
                if (items.length === 0) return alert('2000 ë¯¸ë§Œì˜ ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                let validSelected = currentData.selectedSpecs.filter(s => specs.includes(s));
                if (validSelected.length === 0) validSelected = specs; 
                updateCurrentData({ parsedItems: items, availableSpecs: specs, selectedSpecs: validSelected });
                alert(`ì„±ê³µ! í˜„ì¬ ë™ì—ì„œ ${items.length}ê°œì˜ ë°ì´í„° ê·¸ë£¹ì„ ì½ì–´ì™”ìŠµë‹ˆë‹¤.`);
            };

            const extractAllDongsData = () => {
                let updates = {};
                let count = 0;
                dongs.forEach(dong => {
                    const data = dongDataStore[dong];
                    if(data.gridData.length > 0) {
                        const { items, specs } = extractDataForDong(data);
                        if(items.length > 0) {
                            let validSelected = data.selectedSpecs.filter(s => specs.includes(s));
                            if (validSelected.length === 0) validSelected = specs;
                            updates[dong] = { ...data, parsedItems: items, availableSpecs: specs, selectedSpecs: validSelected };
                            count++;
                        }
                    }
                });
                setDongDataStore(prev => ({ ...prev, ...updates }));
                alert(`ì´ ${count}ê°œ ë™ì˜ ë°ì´í„°ë¥¼ ì¼ê´„ ë¶„ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.`);
            };

            const toggleSpec = (specKey) => {
                let newSelected = [...currentData.selectedSpecs];
                if (newSelected.includes(specKey)) newSelected = newSelected.filter(s => s !== specKey);
                else newSelected.push(specKey);
                updateCurrentData({ selectedSpecs: newSelected });
            };

            const handleGridEdit = (rIdx, cIdx, val) => {
                const newGrid = [...currentData.gridData];
                newGrid[rIdx][cIdx] = val;
                updateCurrentData({ gridData: newGrid });
            };

            const resetExcel = () => {
                updateCurrentData({ gridData: [], parsedItems: [], availableSpecs: [], selectedSpecs: [] });
            };

            const initManualWithSelection = () => {
                if (currentData.selectedSpecs.length === 0) return alert("ì‘ì„±í•  ê·œê²©ì„ í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.");
                
                let newManualRows = { ...currentData.manualRows };
                let firstAdded = null;

                currentData.selectedSpecs.forEach(spec => {
                    if (!newManualRows[spec]) {
                        const parts = spec.match(/(\d+)\*(\d+)\s+([\d.]+)T/);
                        let w='100', h='100', t='2.10';
                        if (parts) { w = parts[1]; h = parts[2]; t = parts[3]; }
                        newManualRows[spec] = [getEmptyRow(t, w, h)];
                        if (!firstAdded) firstAdded = spec;
                    }
                });

                updateCurrentData({ manualRows: newManualRows, currentManualSpec: firstAdded || currentData.selectedSpecs[0] || Object.keys(newManualRows)[0] });
                setViewMode('manual');
            };

            const goToManualModeWithAutoInit = () => {
                let updates = {};
                let hasSelection = false;

                dongs.forEach(dong => {
                    const data = dongDataStore[dong];
                    if (data.selectedSpecs.length > 0) {
                        hasSelection = true;
                        let newManualRows = { ...data.manualRows };
                        let firstSpec = data.currentManualSpec;

                        data.selectedSpecs.forEach(spec => {
                            if (!newManualRows[spec]) {
                                const parts = spec.match(/(\d+)\*(\d+)\s+([\d.]+)T/);
                                let w='100', h='100', t='2.10';
                                if (parts) { w = parts[1]; h = parts[2]; t = parts[3]; }
                                newManualRows[spec] = [getEmptyRow(t, w, h)];
                                if (!firstSpec) firstSpec = spec;
                            }
                        });
                        updates[dong] = { ...data, manualRows: newManualRows, currentManualSpec: firstSpec || data.selectedSpecs[0] };
                    }
                });

                if(!hasSelection) {
                    if(!confirm("ì„ íƒëœ ê·œê²©ì´ ì—†ëŠ” ë™ì´ ìˆìŠµë‹ˆë‹¤. ê·¸ë˜ë„ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                }

                setDongDataStore(prev => ({ ...prev, ...updates }));
                setViewMode('manual');
            };

            const startBlankManual = () => {
                let spec = prompt("ê·œê²© ì…ë ¥ (ì˜ˆ: 100*100 2.1T)", "100*100 2.1T");
                if(!spec) return;
                updateCurrentData({ manualRows: { ...currentData.manualRows, [spec]: [getEmptyRow()] }, currentManualSpec: spec });
                setViewMode('manual');
            };

            const convertManualToResult = () => {
                if (Object.keys(currentData.manualRows).length === 0) return alert("ì‘ì„±ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

                let resultsBySpec = {};
                Object.keys(currentData.manualRows).forEach(specKey => {
                    let rows = currentData.manualRows[specKey];
                    if(!resultsBySpec[specKey]) resultsBySpec[specKey] = [];
                    rows.forEach(row => {
                        let validCuts = row.cuts.filter(c => c.l && c.count);
                        if(validCuts.length === 0) return;
                        
                        let qty = parseInt(row.qty || 1);
                        if(isNaN(qty) || qty < 1) qty = 1;

                        let totalLength = validCuts.reduce((sum, c) => sum + (parseFloat(c.l) * parseInt(c.count)), 0);
                        // ìˆœì„œ ìœ ì§€
                        
                        resultsBySpec[specKey].push({
                            thick: parseFloat(row.t), width: parseInt(row.w), height: parseInt(row.h),
                            count: qty, totalLength: totalLength,
                            groups: validCuts.map(c => ({ length: parseFloat(c.l), cutCount: parseInt(c.count), marking: c.marking || '' }))
                        });
                    });
                });

                // ìˆœì„œ ìœ ì§€
                updateCurrentData({ cpResult: resultsBySpec });
                setViewMode('result');
            };

            // ì—‘ì…€ ìŠ¤íƒ€ì¼ ë„¤ë¹„ê²Œì´ì…˜
            const handleCellKeyDown = (e, absRowIdx, colIdx) => {
                if (!['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) return;
                e.preventDefault();

                const totalRows = currentData.manualRows[currentData.currentManualSpec].length * 8;
                let nextRow = absRowIdx;
                let nextCol = colIdx;

                if (e.key === 'ArrowUp') nextRow = absRowIdx - 1;
                if (e.key === 'ArrowDown') nextRow = absRowIdx + 1;
                if (e.key === 'ArrowLeft') nextCol = colIdx - 1;
                if (e.key === 'ArrowRight') nextCol = colIdx + 1;

                const isSpanned = (c) => c <= 3;
                if (isSpanned(colIdx)) {
                    if (e.key === 'ArrowUp') nextRow = absRowIdx - 8;
                    if (e.key === 'ArrowDown') nextRow = absRowIdx + 8;
                }

                if (nextRow < 0) nextRow = 0;
                if (nextRow >= totalRows) nextRow = totalRows - 1;
                
                if (e.key === 'ArrowLeft' && isSpanned(nextCol) && !isSpanned(colIdx)) {
                    nextRow = Math.floor(nextRow / 8) * 8;
                }

                const targetId = `cell-${nextRow}-${nextCol}`;
                const targetEl = document.getElementById(targetId);
                if (targetEl) targetEl.focus();
            };

            const dragItem = useRef(); const dragOverItem = useRef();
            const handleDragStart = (e, index) => { dragItem.current = index; e.dataTransfer.effectAllowed = "move"; };
            const handleDragEnter = (e, index) => { dragOverItem.current = index; };
            const handleDragEnd = () => {
                if(dragItem.current === null || dragOverItem.current === null) return;
                const spec = currentData.currentManualSpec;
                const newRows = [...currentData.manualRows[spec]];
                const item = newRows.splice(dragItem.current, 1)[0];
                newRows.splice(dragOverItem.current, 0, item);
                dragItem.current = null; dragOverItem.current = null;
                updateCurrentData({ manualRows: { ...currentData.manualRows, [spec]: newRows } });
            };

            // ì›ë³¸ í˜„í™©
            const originalSummary = useMemo(() => {
                const summary = {};
                currentData.parsedItems.forEach(item => {
                    const key = `${item.specKey}_${item.length}_${item.marking || ''}`;
                    if (!summary[key]) summary[key] = { ...item, required: 0 };
                    summary[key].required += item.qty;
                });
                return Object.values(summary).sort((a, b) => a.length - b.length);
            }, [currentData.parsedItems]);

            // ì‹¤ì‹œê°„ ì”ì—¬ í˜„í™© (ì˜¤íƒ€/ì‹ ê·œ ê°ì§€ ë¡œì§ ê°œì„ )
            const remainingSummary = useMemo(() => {
                const summary = {};
                
                // 1. ì›ë³¸ ë°ì´í„° ì„¸íŒ…
                currentData.parsedItems.forEach(item => {
                    const key = `${item.specKey}_${item.length}_${item.marking || ''}`;
                    if (!summary[key]) {
                        summary[key] = { 
                            ...item, 
                            required: 0, 
                            used: 0, 
                            isOriginal: true 
                        };
                    }
                    summary[key].required += item.qty;
                });

                // 2. ìˆ˜ë™ ì…ë ¥ ë°ì´í„° ë°˜ì˜
                if (currentData.manualRows) {
                    Object.keys(currentData.manualRows).forEach(specKey => {
                        const rows = currentData.manualRows[specKey];
                        rows.forEach(row => {
                            row.cuts.forEach(cut => {
                                if (cut.l && cut.count) {
                                    const cutLen = parseFloat(cut.l);
                                    const count = parseInt(cut.count) || 0;
                                    const rowQty = parseInt(row.qty) || 1;
                                    const totalQty = count * rowQty;
                                    const marking = (cut.marking || '').trim();

                                    const key = `${specKey}_${cutLen}_${marking}`;

                                    if (summary[key]) {
                                        summary[key].used += totalQty;
                                    } else {
                                        // ì›ë³¸ì— ì—†ëŠ” ìì¬ (ì˜¤ì…ë ¥ or ì¶”ê°€ìƒì‚°)
                                        summary[key] = {
                                            specKey: specKey,
                                            width: parseInt(row.w),
                                            height: parseInt(row.h),
                                            length: cutLen,
                                            marking: marking,
                                            required: 0,
                                            used: totalQty,
                                            isOriginal: false
                                        };
                                    }
                                }
                            });
                        });
                    });
                }
                
                // ì •ë ¬: ê¸¸ì´ ì˜¤ë¦„ì°¨ìˆœ
                return Object.values(summary).sort((a, b) => a.length - b.length);
            }, [currentData.parsedItems, currentData.manualRows]);

            const downloadExcel = async () => {
                if (!currentData.cpResult) return alert("ì €ì¥í•  CP ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.");
                try {
                    const borderStyle = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
                    const alignCenter = { vertical: 'middle', horizontal: 'center' };
                    const headerFill = { type: 'pattern', pattern:'solid', fgColor:{argb:'FFFFE699'} };
                    const totalFill = { type: 'pattern', pattern:'solid', fgColor:{argb:'FFFFFFCC'} };

                    for (let specKey of Object.keys(currentData.cpResult).sort()) {
                        const patterns = currentData.cpResult[specKey];
                        if (patterns.length === 0) continue;
                        const workbook = new ExcelJS.Workbook();
                        const sheet = workbook.addWorksheet('CP', { pageSetup: { paperSize: 9, orientation: 'landscape', fitToPage: true, fitToWidth: 1, fitToHeight: 0 } });

                        let comp = projectInfo.company || 'ì—…ì²´ëª…'; let site = projectInfo.siteName || 'í˜„ì¥ëª…';
                        let title = `${comp}(${site})`;
                        if (!projectInfo.isNoDong) title += ` - ${currentDong}`;
                        title += ` [${specKey}]`;

                        sheet.mergeCells('A1:N1');
                        const titleCell = sheet.getCell('A1'); titleCell.value = title;
                        titleCell.font = { name: 'Malgun Gothic', size: 16, bold: true };

                        let warnings = [];
                        if (projectInfo.isBanding) warnings.push("ì² ë°´ë”©ì— ë™í‘œì‹œ í•´ì£¼ì„¸ìš”");
                        if (projectInfo.isUnder1Ton) warnings.push("1í†¤ ë¯¸ë§Œ ë°´ë”©");
                        if (projectInfo.memo) warnings.push(projectInfo.memo);
                        if (warnings.length > 0) {
                            sheet.mergeCells('A3:G3');
                            const warnCell = sheet.getCell('A3'); warnCell.value = warnings.join(", ");
                            warnCell.font = { name: 'Malgun Gothic', size: 12, bold: true, color: { argb: 'FFFF0000' } };
                        }

                        const headers = ["ìˆœë²ˆ", "ë‘ê»˜", "ì¥ë³€", "ë‹¨ë³€", "ì„ íƒ€ê³µê¸¸ì´", "ìˆ˜ëŸ‰", "ë‹¨ì²™ê¸¸ì´", "ì»·íŒ… ìˆ˜", "ìˆ˜ëŸ‰", "ë§ˆí‚¹", "í•©ê³„", "ë¡œìŠ¤", "ì»·íŒ…ë‚ ", "ë¹„ê³ "];
                        const headerRow = sheet.getRow(4); headerRow.values = headers; headerRow.height = 30;
                        headerRow.eachCell((cell) => { cell.fill = headerFill; cell.font = { name: 'Malgun Gothic', size: 11, bold: true }; cell.alignment = alignCenter; cell.border = borderStyle; });

                        let currentRow = 5; let totalRaw = 0; let totalCut = 0;
                        patterns.forEach((pattern, index) => {
                            const rowsInBatch = pattern.groups.length;
                            const totalUsed = pattern.totalLength;
                            const cuts = pattern.groups.reduce((s, it) => s + it.cutCount, 0);
                            const bladeLoss = Math.round(cuts * 2.6);
                            totalRaw += pattern.count; totalCut += (cuts * pattern.count);
                            const startRow = currentRow;

                            pattern.groups.forEach((group, idx) => {
                                const row = sheet.getRow(currentRow); row.height = 25;
                                row.getCell(7).value = group.length; row.getCell(8).value = group.cutCount;
                                row.getCell(9).value = group.cutCount * pattern.count; row.getCell(10).value = group.marking;
                                row.getCell(10).alignment = { vertical: 'middle', horizontal: 'left', indent: 1 };

                                if (idx === 0) {
                                    row.getCell(1).value = index + 1; row.getCell(2).value = pattern.thick;
                                    row.getCell(3).value = pattern.width; row.getCell(4).value = pattern.height;
                                    row.getCell(6).value = pattern.count; row.getCell(11).value = totalUsed;
                                    row.getCell(12).value = { formula: `E${currentRow}-K${currentRow}`, result: -totalUsed };
                                    row.getCell(13).value = bladeLoss;
                                }
                                for(let c=1; c<=14; c++) { const cell = row.getCell(c); cell.border = borderStyle; if(c!==10) cell.alignment = alignCenter; cell.font = { name: 'Malgun Gothic', size: 11 }; }
                                currentRow++;
                            });
                            if (rowsInBatch > 1) { const endRow = currentRow - 1; ['A','B','C','D','E','F','K','L','M','N'].forEach(col => { sheet.mergeCells(`${col}${startRow}:${col}${endRow}`); }); }
                        });

                        const totalRow = sheet.getRow(currentRow); totalRow.height = 30;
                        sheet.mergeCells(`A${currentRow}:E${currentRow}`); sheet.getCell(`A${currentRow}`).value = "í•© ê³„";
                        sheet.getCell(`F${currentRow}`).value = totalRaw;
                        sheet.mergeCells(`G${currentRow}:H${currentRow}`); sheet.getCell(`G${currentRow}`).value = "í•© ê³„";
                        sheet.getCell(`I${currentRow}`).value = totalCut;
                        for(let c=1; c<=14; c++) { const cell = totalRow.getCell(c); cell.fill = totalFill; cell.border = borderStyle; cell.alignment = alignCenter; cell.font = { name: 'Malgun Gothic', size: 11, bold: true }; }
                        sheet.columns = [ { width: 8 }, { width: 8 }, { width: 8 }, { width: 8 }, { width: 12 }, { width: 8 }, { width: 12 }, { width: 8 }, { width: 8 }, { width: 15 }, { width: 12 }, { width: 12 }, { width: 8 }, { width: 15 } ];

                        const buffer = await workbook.xlsx.writeBuffer();
                        let filename = `${comp}(${site})`;
                        if (!projectInfo.isNoDong) filename += `_${currentDong}`;
                        filename += `_${specKey}.xlsx`;
                        saveAs(new Blob([buffer]), filename);
                    }
                } catch(e) { alert("ì—‘ì…€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.message); }
            };

            const hasResults = currentData.cpResult && Object.values(currentData.cpResult).some(p => p.length > 0);

            return (
                <div className="flex h-screen overflow-hidden text-gray-800">
                    <div className="w-[280px] bg-white border-r border-gray-200 flex flex-col z-10 shadow">
                        <div className="p-6 border-b bg-blue-900 text-white">
                            <h1 className="text-xl font-bold flex items-center gap-2">ğŸ› ï¸ Smart Manual CP</h1>
                            <p className="text-xs opacity-80 mt-1">ì‹¤ì‹œê°„ ê²€ì¦ & ìˆ˜ë™ ìµœì í™”</p>
                        </div>
                        <div className="p-4 flex-1 overflow-auto">
                            <div className="space-y-3 mb-6">
                                <label className="text-xs font-bold text-gray-500">í”„ë¡œì íŠ¸ ì •ë³´</label>
                                <input className="w-full p-2 border rounded text-sm bg-gray-50 outline-none focus:ring-2 focus:ring-blue-500" placeholder="ì—…ì²´ëª… (ì˜ˆ: ì˜¤ì„œì—ë„ˆì§€)" value={projectInfo.company} onChange={e => setProjectInfo({...projectInfo, company: e.target.value})} />
                                <input className="w-full p-2 border rounded text-sm bg-gray-50 outline-none focus:ring-2 focus:ring-blue-500" placeholder="í˜„ì¥ëª… (ì˜ˆ: ê¹€ì²œê³µì¥)" value={projectInfo.siteName} onChange={e => setProjectInfo({...projectInfo, siteName: e.target.value})} />
                                <input className="w-full p-2 border rounded text-sm bg-gray-50 outline-none focus:ring-2 focus:ring-blue-500" placeholder="ê¸°íƒ€ì‚¬í•­ (ë©”ëª¨)" value={projectInfo.memo} onChange={e => setProjectInfo({...projectInfo, memo: e.target.value})} />
                                <div className="flex flex-col gap-1 mt-2">
                                    <label className="flex items-center gap-2 text-xs cursor-pointer font-bold text-blue-700">
                                        <input type="checkbox" checked={projectInfo.isNoDong} onChange={e => setProjectInfo({...projectInfo, isNoDong: e.target.checked})} /> ë™ êµ¬ë¶„ ì—†ìŒ
                                    </label>
                                    <label className="flex items-center gap-2 text-xs cursor-pointer">
                                        <input type="checkbox" checked={projectInfo.isBanding} onChange={e => setProjectInfo({...projectInfo, isBanding: e.target.checked})} /> ì² ë°´ë”© ë™í‘œê¸°
                                    </label>
                                    <label className="flex items-center gap-2 text-xs cursor-pointer">
                                        <input type="checkbox" checked={projectInfo.isUnder1Ton} onChange={e => setProjectInfo({...projectInfo, isUnder1Ton: e.target.checked})} /> 1í†¤ ë¯¸ë§Œ ë°´ë”©
                                    </label>
                                </div>
                            </div>
                            <div className="space-y-2 border-t pt-4">
                                <button onClick={() => setViewMode('input')} className={`w-full text-left px-4 py-3 rounded-lg font-bold text-sm ${viewMode === 'input' ? 'bg-blue-50 text-blue-700 border border-blue-200' : 'text-gray-600 hover:bg-gray-100'}`}>1. ì—‘ì…€ ë°ì´í„° ì½ê¸°</button>
                                <button onClick={() => setViewMode('manual')} className={`w-full text-left px-4 py-3 rounded-lg font-bold text-sm ${viewMode === 'manual' ? 'bg-blue-50 text-blue-700 border border-blue-200' : 'text-gray-600 hover:bg-gray-100'}`}>2. ì§ì ‘ ì‘ì„± / ìˆ˜ì •</button>
                                <button onClick={() => { if(Object.keys(currentData.manualRows).length === 0) { alert("ì‘ì„±ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ìˆ˜ë™ íƒ­ì—ì„œ ë¨¼ì € ì‘ì„±í•˜ì„¸ìš”."); return; } convertManualToResult(); }} className={`w-full text-left px-4 py-3 rounded-lg font-bold text-sm ${viewMode === 'result' ? 'bg-blue-50 text-blue-700 border border-blue-200' : 'text-gray-600 hover:bg-gray-100'}`}>3. ê²°ê³¼ í™•ì¸ (CPí‘œ)</button>
                            </div>
                        </div>
                    </div>

                    <div className="flex-1 flex flex-col relative overflow-hidden bg-gray-50">
                        {!projectInfo.isNoDong && (
                            <div className="bg-white border-b border-gray-200 px-6 pt-3 flex gap-2 overflow-x-auto">
                                {dongs.map(dong => (
                                    <div key={dong} className="relative group">
                                        <button onClick={() => setCurrentDong(dong)} className={`px-4 py-2 rounded-t-lg font-bold text-sm border-t border-x ${currentDong === dong ? 'bg-white border-gray-200 text-blue-800 pb-3' : 'bg-gray-100 border-transparent text-gray-500 hover:bg-gray-200'} transition-all`}>
                                            {dong}
                                        </button>
                                        <button onClick={(e) => { e.stopPropagation(); deleteDong(dong); }} className={`absolute right-1 top-2 p-1 text-gray-400 hover:text-red-500 ${currentDong === dong ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'}`}><Trash2 /></button>
                                    </div>
                                ))}
                                <button onClick={addDong} className="px-3 py-2 text-gray-500 hover:text-blue-800 font-bold"><Plus /></button>
                            </div>
                        )}

                        {viewMode === 'input' && (
                            <div className="p-6 h-full flex flex-col overflow-auto custom-scrollbar">
                                <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex justify-between items-center mb-4">
                                    <div className="flex gap-2">
                                        <button onClick={() => updateCurrentData({ inputMode: 'sales', colMapping: { 1: 'width', 2: 'height', 3: 'thickness', 4: 'length', 8: 'qty', 13: 'marking' } })} className={`px-4 py-2 text-sm font-bold rounded ${currentData.inputMode === 'sales' ? 'bg-blue-800 text-white shadow' : 'bg-gray-100 text-gray-600'}`}>ì˜ì—… ì–‘ì‹</button>
                                        <button onClick={() => updateCurrentData({ inputMode: 'design', colMapping: { 2: 'width', 3: 'height', 4: 'thickness', 5: 'length', 7: 'qty', 8: 'marking' } })} className={`px-4 py-2 text-sm font-bold rounded ${currentData.inputMode === 'design' ? 'bg-blue-800 text-white shadow' : 'bg-gray-100 text-gray-600'}`}>ì„¤ê³„ ì–‘ì‹</button>
                                    </div>
                                    <div className="flex gap-2 items-center">
                                        <button onClick={extractAllDongsData} className="px-5 py-2 bg-indigo-700 text-white text-sm font-bold rounded hover:bg-indigo-800 shadow flex items-center gap-1"><Refresh /> ì „ì²´ ë™ ë°ì´í„° ì¼ê´„ ì½ê¸°</button>
                                        <button onClick={extractData} className="px-5 py-2 bg-gray-800 text-white text-sm font-bold rounded hover:bg-black shadow">í˜„ì¬ ë™ë§Œ ì½ê¸°</button>
                                    </div>
                                </div>
                                <div className="flex-1 flex gap-4 overflow-hidden">
                                    <div className="flex-[3] bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col relative overflow-hidden">
                                        <div className="p-2 border-b bg-gray-50 flex justify-end">
                                            <button onClick={resetExcel} className="flex items-center gap-1 text-xs font-bold text-red-500 hover:bg-red-50 px-2 py-1 rounded"><Refresh /> ì´ˆê¸°í™” (ë‹¤ì‹œ ë¶™ì—¬ë„£ê¸°)</button>
                                        </div>
                                        {currentData.gridData.length === 0 ? (
                                            <div className="absolute inset-0 flex items-center justify-center bg-gray-50"><textarea className="absolute inset-0 opacity-0 cursor-text" onPaste={handlePaste} autoFocus /><div className="text-center text-gray-400 pointer-events-none"><p className="text-4xl font-bold mb-3">ğŸ“‹ Ctrl + V</p><p>ì—‘ì…€ ê²¬ì ì„œ í‘œë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”</p></div></div>
                                        ) : (
                                            <div className="h-full overflow-auto custom-scrollbar">
                                                <table className="w-full text-xs border-collapse">
                                                    <thead className="sticky top-0 bg-white shadow-sm z-10">
                                                        <tr>
                                                            <th className="p-2 border bg-gray-100 w-10 text-center">#</th>
                                                            {currentData.gridData[0].map((_, cIdx) => (
                                                                <th key={cIdx} className="p-1 border min-w-[80px]">
                                                                    <select className={`w-full p-1 border rounded text-xs font-bold outline-none ${['length', 'qty'].includes(currentData.colMapping[cIdx]) ? 'bg-blue-100 text-blue-700' : 'bg-gray-50'}`} value={currentData.colMapping[cIdx] || ''} onChange={e => updateCurrentData({ colMapping: {...currentData.colMapping, [cIdx]: e.target.value} })}>
                                                                        <option value="">- ë¬´ì‹œ -</option><option value="thickness">ë‘ê»˜(T)</option><option value="width">ì¥ë³€(W)</option><option value="height">ë‹¨ë³€(H)</option><option value="length">ğŸ“ ê¸¸ì´</option><option value="qty">ğŸ”¢ ìˆ˜ëŸ‰</option><option value="marking">ë§ˆí‚¹</option>
                                                                    </select>
                                                                </th>
                                                            ))}
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {currentData.gridData.slice(0, 50).map((row, rIdx) => {
                                                            const lenIdx = Object.keys(currentData.colMapping).find(k => currentData.colMapping[k] === 'length');
                                                            let isUnder2000 = false;
                                                            if (lenIdx) {
                                                                let rawLen = parseFloat(String(row[lenIdx]||'').replace(/,/g, '').trim());
                                                                let lenInMm = (rawLen > 0 && rawLen < 20) ? Math.round(rawLen * 1000) : Math.round(rawLen);
                                                                if (lenInMm > 0 && lenInMm < 2000) isUnder2000 = true;
                                                            }
                                                            return (
                                                                <tr key={rIdx} className={isUnder2000 ? "bg-red-50 text-red-600 font-bold" : "hover:bg-blue-50"}>
                                                                    <td className="p-2 border text-center text-gray-400 bg-gray-50">{rIdx + 1}</td>
                                                                    {row.map((cell, cIdx) => (
                                                                        <td key={cIdx} className="border p-0 h-8">
                                                                            <input className={`excel-input-cell ${isUnder2000 ? "text-red-600 font-bold" : ""}`} value={cell} onChange={(e) => handleGridEdit(rIdx, cIdx, e.target.value)} />
                                                                        </td>
                                                                    ))}
                                                                </tr>
                                                            );
                                                        })}
                                                    </tbody>
                                                </table>
                                            </div>
                                        )}
                                    </div>
                                    <div className="flex-[1] bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col overflow-hidden min-w-[250px]">
                                        <div className="p-3 bg-indigo-600 text-white font-bold text-sm text-center">ê²€ì¶œëœ ê·œê²© ëª©ë¡</div>
                                        <div className="p-2 text-xs text-gray-500 bg-gray-50 text-center border-b">
                                            ì²´í¬í•œ ê·œê²©ë§Œ ì‘ì„± í™”ë©´ì— ìƒì„±ë©ë‹ˆë‹¤.
                                        </div>
                                        <div className="flex-1 overflow-auto custom-scrollbar p-3 space-y-1">
                                            {currentData.availableSpecs.length === 0 ? <div className="text-gray-400 text-center mt-10">ë°ì´í„°ë¥¼ ë¨¼ì € ì½ì–´ì£¼ì„¸ìš”</div> : currentData.availableSpecs.map(spec => (
                                                <div key={spec} className={`checkbox-wrapper ${currentData.selectedSpecs.includes(spec) ? 'selected' : ''}`} onClick={() => toggleSpec(spec)}>
                                                    <div className={`w-4 h-4 rounded border flex items-center justify-center mr-2 ${currentData.selectedSpecs.includes(spec) ? 'bg-blue-500 border-blue-500 text-white' : 'border-gray-300'}`}>
                                                        {currentData.selectedSpecs.includes(spec) && <Check />}
                                                    </div>
                                                    <span className="font-bold text-sm text-gray-700">{spec}</span>
                                                </div>
                                            ))}
                                        </div>
                                        <div className="p-3 bg-gray-50 border-t">
                                            <button onClick={goToManualModeWithAutoInit} className="w-full py-2 bg-green-600 hover:bg-green-700 text-white rounded font-bold text-sm shadow flex justify-center items-center gap-2">
                                                âœï¸ ê·œê²© í™•ì • ë° ì‘ì„±í™”ë©´ ì´ë™
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {viewMode === 'manual' && (
                            <div className="p-6 h-full flex gap-4 overflow-hidden">
                                <div className="flex-1 flex flex-col bg-white rounded-xl shadow border border-gray-200 overflow-hidden">
                                    <div className="p-4 border-b bg-gray-50 flex justify-between items-center">
                                        <div className="flex gap-2 overflow-x-auto pb-1 max-w-[600px] custom-scrollbar">
                                            {Object.keys(currentData.manualRows).length > 0 ? Object.keys(currentData.manualRows).map(spec => (
                                                <button key={spec} onClick={() => updateCurrentData({currentManualSpec: spec})} className={`px-4 py-2 font-bold text-sm rounded whitespace-nowrap ${currentData.currentManualSpec === spec ? 'bg-indigo-600 text-white shadow' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}`}>{spec}</button>
                                            )) : <span className="text-gray-400 font-bold p-2">ìƒì„±ëœ íƒ­ì´ ì—†ìŠµë‹ˆë‹¤</span>}
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={startBlankManual} className="px-4 py-2 bg-indigo-50 text-indigo-700 text-sm font-bold rounded hover:bg-indigo-100 border border-indigo-200">+ ìƒˆ ê·œê²© íƒ­ ì¶”ê°€</button>
                                            <button onClick={() => { if(currentData.currentManualSpec) { const newRows = [...currentData.manualRows[currentData.currentManualSpec], getEmptyRow()]; updateCurrentData({manualRows: {...currentData.manualRows, [currentData.currentManualSpec]: newRows}});} }} className="px-4 py-2 border border-dashed border-gray-400 text-gray-600 text-sm font-bold rounded hover:bg-white">+ í–‰ ì¶”ê°€</button>
                                            <button onClick={convertManualToResult} className="px-5 py-2 bg-green-600 text-white text-sm font-bold rounded shadow hover:bg-green-700">ì‘ì„± ì™„ë£Œ (ê²°ê³¼ë³´ê¸°)</button>
                                        </div>
                                    </div>
                                    <div className="flex-1 overflow-auto custom-scrollbar p-0 relative bg-gray-50">
                                        {!currentData.currentManualSpec ? <div className="flex items-center justify-center h-full text-gray-400 font-bold text-lg">ìƒë‹¨ ë²„íŠ¼ì„ ëˆŒëŸ¬ ê·œê²©ì„ ì¶”ê°€í•˜ê±°ë‚˜ ì„ íƒí•˜ì„¸ìš”</div> : (
                                            <table className="w-full text-xs text-center border-collapse bg-white">
                                                <thead className="sticky top-0 bg-white shadow-sm z-10">
                                                    <tr className="bg-gray-100 text-gray-600">
                                                        <th className="border p-2 w-12">ì´ë™</th><th className="border p-2 w-14">ë‘ê»˜</th><th className="border p-2 w-14">ì¥ë³€</th><th className="border p-2 w-14">ë‹¨ë³€</th><th className="border p-2 w-14 bg-yellow-100 text-yellow-800">QTY</th>
                                                        <th className="border p-2 bg-blue-50 text-blue-800">ë‹¨ì²™ê¸¸ì´ (mm)</th><th className="border p-2 bg-blue-50 text-blue-800 w-16">ì»·íŒ…ìˆ˜</th><th className="border p-2 bg-blue-50 text-blue-800">ë§ˆí‚¹</th>
                                                        <th className="border p-2 bg-red-50 text-red-800 w-24">í•©ê³„</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {currentData.manualRows[currentData.currentManualSpec].map((row, rIdx) => {
                                                        const validCuts = row.cuts.filter(c => c.l && c.count);
                                                        const rowSum = validCuts.reduce((acc, c) => acc + (parseFloat(c.l) * parseInt(c.count)), 0);
                                                        let sumBgColor = 'bg-gray-50 text-gray-500';
                                                        if (rowSum > 5850) sumBgColor = 'bg-red-100 text-red-600 font-bold';
                                                        else if (rowSum > 0 && rowSum < 2000) sumBgColor = 'bg-yellow-100 text-yellow-700 font-bold';
                                                        else if (rowSum >= 2000) sumBgColor = 'bg-green-100 text-green-700 font-bold';
                                                        
                                                        return row.cuts.map((cut, cIdx) => (
                                                            <tr 
                                                                key={`${row.id}-${cIdx}`} 
                                                                onDragEnter={(e) => handleDragEnter(e, rIdx)} 
                                                                onDragOver={(e) => e.preventDefault()} 
                                                                className="border-b border-gray-200 hover:bg-gray-50 transition-colors"
                                                            >
                                                                {cIdx === 0 && (
                                                                    <>
                                                                        <td rowSpan={8} className="border bg-gray-50">
                                                                            <div className="flex flex-col items-center justify-center gap-2 p-1">
                                                                                <div 
                                                                                    className="drag-handle p-1 cursor-grab active:cursor-grabbing" 
                                                                                    title="ë“œë˜ê·¸í•´ì„œ ìˆœì„œ ì´ë™"
                                                                                    draggable={true}
                                                                                    onDragStart={(e) => handleDragStart(e, rIdx)}
                                                                                    onDragEnd={handleDragEnd}
                                                                                >
                                                                                    <DragIcon />
                                                                                </div>
                                                                                <button onClick={() => { const newRows = currentData.manualRows[currentData.currentManualSpec].filter((_, i) => i !== rIdx); updateCurrentData({manualRows: {...currentData.manualRows, [currentData.currentManualSpec]: newRows}}); }} className="p-1 text-red-400 hover:text-red-600 hover:bg-red-50 rounded"><Trash2 /></button>
                                                                            </div>
                                                                        </td>
                                                                        <td rowSpan={8} className="border"><input id={`cell-${rIdx * 8}-0`} onKeyDown={(e) => handleCellKeyDown(e, rIdx * 8, 0)} className="input-cell bg-yellow-50" value={row.t} onChange={e => { const n = [...currentData.manualRows[currentData.currentManualSpec]]; n[rIdx].t = e.target.value; updateCurrentData({manualRows: {...currentData.manualRows, [currentData.currentManualSpec]: n}}); }} /></td>
                                                                        <td rowSpan={8} className="border"><input id={`cell-${rIdx * 8}-1`} onKeyDown={(e) => handleCellKeyDown(e, rIdx * 8, 1)} className="input-cell bg-yellow-50" value={row.w} onChange={e => { const n = [...currentData.manualRows[currentData.currentManualSpec]]; n[rIdx].w = e.target.value; updateCurrentData({manualRows: {...currentData.manualRows, [currentData.currentManualSpec]: n}}); }} /></td>
                                                                        <td rowSpan={8} className="border"><input id={`cell-${rIdx * 8}-2`} onKeyDown={(e) => handleCellKeyDown(e, rIdx * 8, 2)} className="input-cell bg-yellow-50" value={row.h} onChange={e => { const n = [...currentData.manualRows[currentData.currentManualSpec]]; n[rIdx].h = e.target.value; updateCurrentData({manualRows: {...currentData.manualRows, [currentData.currentManualSpec]: n}}); }} /></td>
                                                                        <td rowSpan={8} className="border"><input id={`cell-${rIdx * 8}-3`} onKeyDown={(e) => handleCellKeyDown(e, rIdx * 8, 3)} type="number" className="input-cell bg-yellow-50 font-bold text-lg text-yellow-900" value={row.qty} onChange={e => { const n = [...currentData.manualRows[currentData.currentManualSpec]]; n[rIdx].qty = e.target.value; updateCurrentData({manualRows: {...currentData.manualRows, [currentData.currentManualSpec]: n}}); }} /></td>
                                                                    </>
                                                                )}
                                                                <td className="border p-0">
                                                                    <input 
                                                                        id={`cell-${rIdx * 8 + cIdx}-4`}
                                                                        onKeyDown={(e) => handleCellKeyDown(e, rIdx * 8 + cIdx, 4)}
                                                                        name="cut_length"
                                                                        type="text" 
                                                                        className={`input-cell ${parseFloat(cut.l) < 2000 && cut.l !== '' ? 'warn-low-length' : ''}`} 
                                                                        value={cut.l} 
                                                                        onChange={e => { const n = [...currentData.manualRows[currentData.currentManualSpec]]; n[rIdx].cuts[cIdx].l = e.target.value; updateCurrentData({manualRows: {...currentData.manualRows, [currentData.currentManualSpec]: n}}); }} 
                                                                    />
                                                                </td>
                                                                <td className="border p-0">
                                                                    <input 
                                                                        id={`cell-${rIdx * 8 + cIdx}-5`}
                                                                        onKeyDown={(e) => handleCellKeyDown(e, rIdx * 8 + cIdx, 5)}
                                                                        name="cut_count"
                                                                        type="text" 
                                                                        className="input-cell" 
                                                                        value={cut.count} 
                                                                        onChange={e => { const n = [...currentData.manualRows[currentData.currentManualSpec]]; n[rIdx].cuts[cIdx].count = e.target.value; updateCurrentData({manualRows: {...currentData.manualRows, [currentData.currentManualSpec]: n}}); }} 
                                                                    />
                                                                </td>
                                                                <td className="border p-0">
                                                                    <input 
                                                                        id={`cell-${rIdx * 8 + cIdx}-6`}
                                                                        onKeyDown={(e) => handleCellKeyDown(e, rIdx * 8 + cIdx, 6)}
                                                                        name="cut_mark"
                                                                        className="input-cell" 
                                                                        value={cut.marking} 
                                                                        onChange={e => { const n = [...currentData.manualRows[currentData.currentManualSpec]]; n[rIdx].cuts[cIdx].marking = e.target.value; updateCurrentData({manualRows: {...currentData.manualRows, [currentData.currentManualSpec]: n}}); }} 
                                                                    />
                                                                </td>
                                                                {cIdx === 0 && <td rowSpan={8} className={`border text-base transition-colors ${sumBgColor}`}>{rowSum === 0 ? '-' : rowSum.toLocaleString()}</td>}
                                                            </tr>
                                                        ));
                                                    })}
                                                </tbody>
                                            </table>
                                        )}
                                    </div>
                                </div>
                                <div className="w-[340px] bg-white rounded-xl shadow border flex flex-col overflow-hidden">
                                    <div className="flex-1 border-b flex flex-col overflow-hidden">
                                        <div className="p-2 bg-gray-700 text-white text-sm font-bold text-center">ì›ë³¸ ìš”ì²­ í˜„í™© (ê³ ì •)</div>
                                        <div className="flex-1 overflow-auto custom-scrollbar p-0">
                                            <table className="w-full text-xs text-center border-collapse">
                                                <thead className="sticky top-0 bg-white shadow-sm">
                                                    <tr className="bg-gray-100 border-b"><th className="p-2">ê·œê²©</th><th className="p-2">ê¸¸ì´</th><th className="p-2">ìˆ˜ëŸ‰</th><th className="p-2">ë§ˆí‚¹</th></tr>
                                                </thead>
                                                <tbody>
                                                    {originalSummary.length === 0 ? <tr><td colSpan="4" className="p-4 text-gray-400">ë°ì´í„° ì—†ìŒ</td></tr> : originalSummary.map((item, i) => (
                                                        <tr key={i} className="border-b hover:bg-gray-50">
                                                            <td className="p-2 text-left">{item.width}*{item.height}</td>
                                                            <td className="p-2 font-bold">{item.length}</td>
                                                            <td className="p-2">{item.required}</td>
                                                            <td className="p-2">{item.marking}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div className="flex-1 flex flex-col overflow-hidden bg-white">
                                        <div className="p-2 bg-blue-800 text-white text-sm font-bold text-center">ì‹¤ì‹œê°„ ì”ì—¬ í˜„í™©</div>
                                        <div className="flex-1 overflow-auto custom-scrollbar p-0">
                                            <table className="w-full text-xs text-center border-collapse">
                                                <thead className="sticky top-0 bg-white shadow-sm">
                                                    <tr className="bg-gray-100 border-b"><th className="p-2">ê·œê²©</th><th className="p-2">ê¸¸ì´</th><th className="p-2">í•„ìš”</th><th className="p-2">ì‚¬ìš©</th><th className="p-2">ì”ì—¬</th><th className="p-2">ë§ˆí‚¹</th></tr>
                                                </thead>
                                                <tbody>
                                                    {remainingSummary.map((item, i) => {
                                                        const remaining = item.required - item.used;
                                                        // ì›ë³¸ì— ì—†ëŠ” ìì¬(ì˜¤íƒ€ ë“±)ì¸ ê²½ìš° ë³´ë¼ìƒ‰ í‘œì‹œ
                                                        const isUnexpected = !item.isOriginal; 
                                                        
                                                        let rowClass = "border-b ";
                                                        if (isUnexpected) rowClass += "bg-purple-100 text-purple-900 font-bold";
                                                        else if (remaining === 0) rowClass += "bg-gray-50 text-gray-400";
                                                        else rowClass += "hover:bg-blue-50";

                                                        return (
                                                            <tr key={i} className={rowClass}>
                                                                <td className="p-2 text-left">{item.width}*{item.height}</td>
                                                                <td className="p-2 font-bold">{item.length}</td>
                                                                <td className="p-2">{item.required}</td>
                                                                <td className="p-2 text-blue-600">{item.used}</td>
                                                                <td className={`p-2 font-bold ${isUnexpected ? 'text-purple-600' : (remaining < 0 ? 'text-red-500' : (remaining === 0 ? 'text-green-500' : 'text-blue-600'))}`}>
                                                                    {remaining}
                                                                    {isUnexpected && <span className="ml-1 text-[10px] bg-purple-200 px-1 rounded text-purple-800">ì¶”ê°€ë¨</span>}
                                                                </td>
                                                                <td className="p-2 text-left truncate max-w-[60px]" title={item.marking}>{item.marking}</td>
                                                            </tr>
                                                        );
                                                    })}
                                                    {remainingSummary.length === 0 && <tr><td colSpan="6" className="p-8 text-gray-400 text-center">1ë²ˆ íƒ­ì—ì„œ ë°ì´í„°ë¥¼ ë¨¼ì € ì½ì–´ì£¼ì„¸ìš”.</td></tr>}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {viewMode === 'result' && (
                            <div className="p-8 h-full overflow-auto custom-scrollbar bg-white">
                                {!hasResults ? (
                                    <div className="text-center text-gray-400 mt-20 text-lg">ì‘ì„±ëœ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                                ) : (
                                    <div className="max-w-[1200px] mx-auto pb-20">
                                        <div className="flex justify-end gap-3 mb-6">
                                            <button onClick={() => setViewMode('manual')} className="flex items-center gap-2 bg-gray-600 text-white px-5 py-2 rounded-lg shadow font-bold hover:bg-gray-700 transition">ìˆ˜ì •í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
                                            <button onClick={downloadExcel} className="flex items-center gap-2 bg-green-600 text-white px-5 py-2 rounded-lg shadow font-bold hover:bg-green-700 transition"><Download /> ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ</button>
                                        </div>
                                        {Object.keys(currentData.cpResult).sort().map((specKey, mapIndex) => {
                                            const patterns = currentData.cpResult[specKey];
                                            if(patterns.length === 0) return null;
                                            
                                            let comp = projectInfo.company || 'ì—…ì²´ëª…'; let site = projectInfo.siteName || 'í˜„ì¥ëª…';
                                            let displayTitle = `${comp}(${site})`;
                                            if (!projectInfo.isNoDong) displayTitle += ` - ${currentDong}`;
                                            displayTitle += ` [${specKey}]`;

                                            let warnings = [];
                                            if (projectInfo.isBanding) warnings.push("ì² ë°´ë”©ì— ë™í‘œì‹œ í•´ì£¼ì„¸ìš”");
                                            if (projectInfo.isUnder1Ton) warnings.push("1í†¤ ë¯¸ë§Œ ë°´ë”©");
                                            if (projectInfo.memo) warnings.push(projectInfo.memo);

                                            return (
                                                <div key={specKey} className={mapIndex > 0 ? "mt-16 pt-8 border-t-2 border-dashed border-gray-300" : ""}>
                                                    <div className="spec-title">ê·œê²©: {specKey}</div>
                                                    <table className="w-full mb-3 border-none">
                                                        <tbody>
                                                            <tr>
                                                                <td className="text-xl font-bold text-left border-none pb-2">{displayTitle}</td>
                                                                <td className="text-sm text-right border-none pb-2">ë‚ ì§œ: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ë‹´ë‹¹ì: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                    {warnings.length > 0 && <div className="text-red-600 font-bold text-lg mb-2">{warnings.join(', ')}</div>}
                                                    <table className="excel-table">
                                                        <thead>
                                                            <tr>
                                                                <th style={{width:'4%'}}>ìˆœë²ˆ</th><th style={{width:'6%'}}>ë‘ê»˜</th><th style={{width:'6%'}}>ì¥ë³€</th><th style={{width:'6%'}}>ë‹¨ë³€</th><th style={{width:'8%'}}>ì„ íƒ€ê³µê¸¸ì´</th><th style={{width:'5%'}}>ìˆ˜ëŸ‰</th><th style={{width:'10%'}}>ë‹¨ì²™ê¸¸ì´</th><th style={{width:'8%'}}>ì»·íŒ… ìˆ˜</th><th style={{width:'6%'}}>ìˆ˜ëŸ‰</th><th style={{width:'15%'}}>ë§ˆí‚¹</th><th style={{width:'8%'}}>í•©ê³„</th><th style={{width:'8%'}}>ë¡œìŠ¤</th><th style={{width:'6%'}}>ì»·íŒ…ë‚ </th><th style={{width:'4%'}}>ë¹„ê³ </th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {patterns.map((pattern, index) => {
                                                                let piecesCount = pattern.groups.length;
                                                                let totalCuts = pattern.groups.reduce((sum, g) => sum + g.cutCount, 0);
                                                                let bladeLoss = (totalCuts * 2.6).toFixed(1).replace('.0', '');
                                                                let displayLoss = `- ${pattern.totalLength.toLocaleString()}`; 
                                                                
                                                                return pattern.groups.map((group, pIdx) => (
                                                                    <tr key={`${index}-${pIdx}`}>
                                                                        {pIdx === 0 && <td rowSpan={piecesCount}>{index + 1}</td>}
                                                                        {pIdx === 0 && <td rowSpan={piecesCount}>{pattern.thick.toFixed(2)}</td>}
                                                                        {pIdx === 0 && <td rowSpan={piecesCount}>{pattern.width}</td>}
                                                                        {pIdx === 0 && <td rowSpan={piecesCount}>{pattern.height}</td>}
                                                                        {pIdx === 0 && <td rowSpan={piecesCount}></td>}
                                                                        {pIdx === 0 && <td rowSpan={piecesCount}>{pattern.count}</td>}
                                                                        <td style={{borderBottom: pIdx === piecesCount - 1 ? '1px solid #000' : '1px dashed #999'}}>{group.length}</td>
                                                                        <td style={{borderBottom: pIdx === piecesCount - 1 ? '1px solid #000' : '1px dashed #999'}}>{group.cutCount}</td>
                                                                        <td style={{borderBottom: pIdx === piecesCount - 1 ? '1px solid #000' : '1px dashed #999'}}>{group.cutCount * pattern.count}</td>
                                                                        <td style={{borderBottom: pIdx === piecesCount - 1 ? '1px solid #000' : '1px dashed #999', textAlign: 'left', paddingLeft: '8px'}}>{group.marking}</td>
                                                                        {pIdx === 0 && <td rowSpan={piecesCount}>{pattern.totalLength.toLocaleString()}</td>}
                                                                        {pIdx === 0 && <td rowSpan={piecesCount}>{displayLoss}</td>}
                                                                        {pIdx === 0 && <td rowSpan={piecesCount}>{bladeLoss}</td>}
                                                                        {pIdx === 0 && <td rowSpan={piecesCount}></td>}
                                                                    </tr>
                                                                ));
                                                            })}
                                                            <tr style={{backgroundColor: '#fff2cc', fontWeight: 'bold'}}>
                                                                <td colSpan="5">í•© ê³„</td>
                                                                <td>{patterns.reduce((sum, p) => sum + p.count, 0)}</td>
                                                                <td colSpan="2">í•© ê³„</td>
                                                                <td>{patterns.reduce((sum, p) => sum + p.groups.reduce((s, c) => s + (c.cutCount * p.count), 0), 0)}</td>
                                                                <td colSpan="5"></td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>